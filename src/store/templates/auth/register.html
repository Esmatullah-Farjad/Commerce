{% extends '_base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans 'Sign Up' %}{% endblock title %}

{% block content %}
<div class="min-h-[calc(100vh-4rem)] flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-lg">

    <form
      action="{% url 'sign-up' %}"
      method="post"
      class="rounded-2xl border border-slate-200 bg-white p-7 shadow-sm"
    >
      {% csrf_token %}

      <!-- Header -->
      <div class="flex items-start gap-3">
        <div class="mt-0.5 flex h-10 w-10 items-center justify-center rounded-xl bg-teal-50 ring-1 ring-inset ring-teal-600/15">
          <svg class="h-5 w-5 text-teal-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
              d="M18 9v3m0 0v3m0-3h3m-3 0h-3M12 12a4 4 0 100-8 4 4 0 000 8zm-7 8a7 7 0 0114 0v1H5v-1z" />
          </svg>
        </div>

        <div class="flex-1">
          <h1 class="text-xl font-semibold text-slate-900 leading-tight">{% trans 'Create account' %}</h1>
          <p class="mt-1 text-sm text-slate-600">{% trans 'Request access to a tenant and store. An admin will activate your account.' %}</p>
        </div>
      </div>

      <!-- Fields -->
      <div class="mt-6 space-y-6">
        <div>
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">{% trans 'Personal details' %}</h2>
            <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600">
              {% trans 'Step 1' %}
            </span>
          </div>
          <div class="mt-3 grid gap-4 sm:grid-cols-2">
            <div>
              <label class="text-xs font-semibold text-slate-700" for="{{ form.first_name.id_for_label }}">
                {{ form.first_name.label }}
              </label>
              <div class="mt-2">
                {{ form.first_name }}
              </div>
              {% if form.first_name.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.first_name.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-700" for="{{ form.last_name.id_for_label }}">
                {{ form.last_name.label }}
              </label>
              <div class="mt-2">
                {{ form.last_name }}
              </div>
              {% if form.last_name.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.last_name.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-700" for="{{ form.username.id_for_label }}">
                {{ form.username.label }}
              </label>
              <div class="mt-2">
                {{ form.username }}
              </div>
              {% if form.username.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.username.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-700" for="{{ form.email.id_for_label }}">
                {{ form.email.label }}
              </label>
              <div class="mt-2">
                {{ form.email }}
              </div>
              {% if form.email.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.email.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-700" for="{{ form.password1.id_for_label }}">
                {{ form.password1.label }}
              </label>
              <div class="mt-2">
                {{ form.password1 }}
              </div>
              {% if form.password1.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.password1.errors|striptags }}</p>
              {% endif %}
            </div>
            <div>
              <label class="text-xs font-semibold text-slate-700" for="{{ form.password2.id_for_label }}">
                {{ form.password2.label }}
              </label>
              <div class="mt-2">
                {{ form.password2 }}
              </div>
              {% if form.password2.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.password2.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">{% trans 'Tenant and store selection' %}</h2>
            <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600">
              {% trans 'Step 2' %}
            </span>
          </div>
          <p class="mt-1 text-xs text-slate-500">{% trans 'Choose the tenant and store you want to join.' %}</p>

          <div class="mt-3 grid gap-4">
            <div>
              <label class="text-xs font-semibold text-slate-700" for="tenant-search">
                {% trans 'Search tenant' %}
              </label>
              <div class="mt-2">
                <input
                  id="tenant-search"
                  type="text"
                  placeholder="{% trans 'Type to filter tenants' %}"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm transition focus:border-primary-500 focus:ring-2 focus:ring-primary-200"
                />
              </div>
            </div>

            <div>
              <label class="text-xs font-semibold text-slate-700" for="tenant_id">
                {{ form.tenant.label }}
              </label>
              <div class="mt-2">
                <select
                  id="tenant_id"
                  name="tenant"
                  required
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm transition focus:border-primary-500 focus:ring-2 focus:ring-primary-200"
                >
                  <option value="">{% trans 'Select a tenant' %}</option>
                  {% with selected_tenant=form.tenant.value %}
                    {% for tenant in tenants %}
                      <option value="{{ tenant.id }}" {% if selected_tenant and selected_tenant|stringformat:"s" == tenant.id|stringformat:"s" %}selected{% endif %}>
                        {{ tenant.name }}
                      </option>
                    {% endfor %}
                  {% endwith %}
                </select>
              </div>
              {% if form.tenant.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.tenant.errors|striptags }}</p>
              {% endif %}
              {% if not tenants %}
                <p class="mt-2 text-xs text-amber-700">{% trans 'No tenants are available. Please contact an admin.' %}</p>
              {% endif %}
            </div>

            <div>
              <label class="text-xs font-semibold text-slate-700" for="store_id">
                {{ form.store.label }}
              </label>
              <div class="mt-2">
                <select
                  id="store_id"
                  name="store"
                  required
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm transition focus:border-primary-500 focus:ring-2 focus:ring-primary-200"
                >
                  <option value="">{% trans 'Select a store' %}</option>
                  {% with selected_store=form.store.value %}
                    {% for store in stores %}
                      <option
                        value="{{ store.id }}"
                        data-tenant="{{ store.tenant_id }}"
                        {% if selected_store and selected_store|stringformat:"s" == store.id|stringformat:"s" %}selected{% endif %}
                      >
                        {{ store.name }}
                      </option>
                    {% endfor %}
                  {% endwith %}
                </select>
              </div>
              {% if form.store.errors %}
                <p class="mt-1 text-xs font-semibold text-rose-600">{{ form.store.errors|striptags }}</p>
              {% endif %}
              <p id="store-hint" class="mt-1 text-xs text-slate-500">{% trans 'Stores are filtered by the selected tenant.' %}</p>
            </div>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
          <p class="font-semibold text-slate-800">{% trans 'What happens next?' %}</p>
          <p class="mt-1">{% trans 'Your account will stay in pending status until an admin activates it and assigns you to a branch.' %}</p>
        </div>
      </div>

      <!-- Submit -->
      <button
        type="submit"
        class="mt-6 w-full inline-flex items-center justify-center gap-2 rounded-xl bg-teal-700 py-2.5 text-sm font-semibold text-white
               shadow-sm hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 4v16m8-8H4" />
        </svg>
        {% trans 'Sign Up' %}
      </button>

      <!-- Footer -->
      <p class="mt-5 text-center text-sm text-slate-600">
        {% trans "Already have an account?" %}
        <a href="{% url 'sign-in' %}" class="font-semibold text-teal-700 hover:text-teal-800">
          {% trans 'Sign In' %}
        </a>
      </p>
    </form>

    <p class="mt-4 text-center text-xs text-slate-500">
      Â© {% now "Y" %} {% trans "Inventory Management System" %}
    </p>
  </div>
</div>

<script>
  (function () {
    const tenantSearch = document.getElementById("tenant-search");
    const tenantSelect = document.getElementById("tenant_id");
    const storeSelect = document.getElementById("store_id");
    const storeHint = document.getElementById("store-hint");
    if (!tenantSelect || !storeSelect) return;

    const tenantOptions = Array.from(tenantSelect.querySelectorAll("option")).slice(1);
    const storeOptions = Array.from(storeSelect.querySelectorAll("option")).slice(1);

    function filterTenants() {
      if (!tenantSearch) return;
      const query = tenantSearch.value.toLowerCase();
      tenantOptions.forEach((option) => {
        const match = option.textContent.toLowerCase().includes(query);
        option.hidden = !match;
      });
    }

    function filterStores() {
      const tenantId = tenantSelect.value;
      let visibleCount = 0;

      storeOptions.forEach((option) => {
        const matches = tenantId && option.dataset.tenant === tenantId;
        option.hidden = !matches;
        option.disabled = !matches;
        if (matches) {
          visibleCount += 1;
        }
      });

      if (!tenantId || visibleCount === 0) {
        storeSelect.value = "";
        storeSelect.disabled = true;
        storeHint.textContent = tenantId
          ? "{% trans 'No stores available for this tenant yet.' %}"
          : "{% trans 'Select a tenant to see stores.' %}";
      } else {
        storeSelect.disabled = false;
        if (storeSelect.selectedOptions.length === 0 || storeSelect.selectedOptions[0].disabled) {
          const firstVisible = storeOptions.find((option) => !option.disabled);
          if (firstVisible) {
            storeSelect.value = firstVisible.value;
          }
        }
        storeHint.textContent = "{% trans 'Stores are filtered by the selected tenant.' %}";
      }
    }

    tenantSelect.addEventListener("change", filterStores);
    if (tenantSearch) {
      tenantSearch.addEventListener("input", filterTenants);
    }

    filterStores();
  })();
</script>

<!-- Optional: if your form fields don't already have Tailwind classes, you can style them globally in your form widgets -->
{% endblock content %}
