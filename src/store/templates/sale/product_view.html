{% extends '_base.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{% trans 'Products' %}{% endblock title %}

{% block content %}
<div class="space-y-4">

  <!-- Header -->
  <div class="rounded-2xl border border-slate-200 bg-white px-6 py-5 shadow-sm">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-start gap-3">
        <div class="mt-0.5 flex h-10 w-10 items-center justify-center rounded-xl bg-teal-50 ring-1 ring-inset ring-teal-600/15">
          <svg class="h-5 w-5 text-teal-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
              d="M20 12H4m16 0a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2v-6a2 2 0 012-2m16 0V9a2 2 0 00-2-2M4 12V9a2 2 0 012-2h12a2 2 0 012 2v3" />
          </svg>
        </div>

        <div>
          <p class="text-xl font-semibold text-slate-900 leading-tight">{% trans 'Products' %}</p>
          <p class="mt-1 text-sm text-slate-600">{% trans 'This page showcases all available products for sale' %}</p>
        </div>
      </div>

      <a
        href="{% url 'scanner-view' %}"
        class="inline-flex items-center justify-center gap-2 rounded-xl bg-teal-700 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
      >
        <img src="{% static 'image/scanner.svg' %}" width="16" height="16" alt="">
        {% trans 'Use Barcode Scanner' %}
      </a>
    </div>
  </div>

  <!-- Search + List -->
  <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">

    <!-- Search -->
    <form action="{% url 'search-products' %}" method="get" class="space-y-2">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <label for="product-search" class="text-sm font-semibold text-slate-900">
            {% trans 'Search Products' %}
            </label>

            <div class="flex items-center gap-2 text-xs text-slate-500">
            <span class="hidden sm:inline">{% trans 'Tip:' %}</span>
            <span class="hidden sm:inline rounded-md border border-slate-200 bg-slate-50 px-2 py-1 font-semibold text-slate-600">
                Ctrl/⌘ + K
            </span>

            <!-- HTMX loading indicator -->
            <span id="search-loading" class="htmx-indicator inline-flex items-center gap-1">
                <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span>{% trans 'Searching...' %}</span>
            </span>
            </div>
        </div>

        <div class="relative">
            <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center">
            <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z" />
            </svg>
            </span>

            <input
            id="product-search"
            type="search"
            name="search"
            autocomplete="off"
            class="w-full rounded-xl border border-slate-200 bg-white pl-10 pr-10 py-2.5 text-sm text-slate-800 shadow-sm
                    placeholder:text-slate-400 focus:border-teal-600 focus:ring-2 focus:ring-teal-200"
            placeholder="{% trans 'Search by name, category, or barcode…' %}"
            value="{{ request.GET.search|default_if_none:'' }}"
            hx-get="{% url 'search-products' %}"
            hx-trigger="keyup changed delay:250ms"
            hx-target="#search-list"
            hx-indicator="#search-loading"
            />

            <button
            type="button"
            id="clear-search"
            class="absolute inset-y-0 right-2 hidden items-center justify-center rounded-lg px-2 text-slate-500 hover:bg-slate-100 hover:text-slate-700"
            aria-label="{% trans 'Clear search' %}"
            title="{% trans 'Clear' %}"
            >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            </button>
        </div>

        <p class="text-xs text-slate-500">
            {% trans 'Type to search. Results update automatically.' %}
        </p>
        </form>

    <!-- Toolbar -->
    <div class="mt-4 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">

      <!-- Cart badge -->
      <div class="flex flex-wrap items-center gap-2 text-sm text-slate-600">
        <span class="inline-flex items-center gap-2 rounded-full bg-teal-50 px-3 py-1 text-xs font-semibold text-teal-800 ring-1 ring-inset ring-teal-600/15">
          <span class="h-1.5 w-1.5 rounded-full bg-teal-600"></span>
          {% trans 'Cart' %}: {{ customer }}
        </span>

        <span class="text-xs uppercase tracking-[0.18em] text-slate-400">{% trans 'Category' %}</span>

        {% with active_cat=request.GET.category %}
          <a
            href="{{ request.path }}"
            class="rounded-full px-3 py-1 text-xs font-semibold ring-1 ring-inset transition
                   {% if not active_cat %} bg-slate-900 text-white ring-slate-900 {% else %} bg-white text-slate-700 ring-slate-200 hover:ring-teal-300 hover:text-teal-700 {% endif %}"
          >
            {% trans 'ALL' %}
          </a>

          {% for category in categories %}
          <a
            href="{{ request.path }}?category={{ category.name }}"
            class="rounded-full px-3 py-1 text-xs font-semibold ring-1 ring-inset transition
                   {% if active_cat == category.name %} bg-slate-900 text-white ring-slate-900 {% else %} bg-white text-slate-700 ring-slate-200 hover:ring-teal-300 hover:text-teal-700 {% endif %}"
          >
            {{ category.name }}
          </a>
          {% endfor %}
        {% endwith %}
      </div>
    </div>

    <!-- Table -->
    <div class="mt-4 overflow-x-auto rounded-xl border border-slate-200">
      <table class="min-w-full text-left text-sm" id="product-table">
        <thead class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-700 border-b border-slate-200">
          <tr>
            <th class="px-3 py-2.5 w-16">{% trans 'Image' %}</th>
            <th class="px-3 py-2.5">{% trans 'Name' %}</th>
            <th class="px-3 py-2.5 w-48">{% trans 'Quantity' %}</th>
            <th class="px-3 py-2.5 w-48">{% trans 'Package' %}</th>
            <th class="px-3 py-2.5 text-right whitespace-nowrap">{% trans 'Item Price' %}</th>
            <th class="px-3 py-2.5 text-right whitespace-nowrap">{% trans 'Package Price' %}</th>
            <th class="px-3 py-2.5 text-center w-24">{% trans 'Action' %}</th>
          </tr>
        </thead>

        <tbody id="search-list" class="divide-y divide-slate-100 bg-white">
          {% for item in products %}
          <tr
            class="hover:bg-slate-50/70"
            data-product-id="{{ item.id }}"
            data-end-point-url="{% url 'add-to-cart' %}"
          >
            <!-- Image -->
            <td class="px-3 py-2.5">
              {% if item.image %}
                <img src="{{ item.image.url }}" alt="image" class="h-9 w-9 rounded-lg object-cover border border-slate-200">
              {% else %}
                <div class="h-9 w-9 rounded-lg border border-slate-200 bg-slate-100"></div>
              {% endif %}
            </td>

            <!-- Name + stock badge -->
            <td class="px-3 py-2.5">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <p class="font-medium text-slate-900 leading-tight truncate">{{ item.name }}</p>
                  <p class="mt-0.5 text-xs text-slate-500 truncate">
                    {% trans 'Category' %}: {{ item.category }}
                  </p>
                </div>

                {% if item.num_of_packages|default:0|add:0 <= 0 %}
                  <span class="shrink-0 inline-flex items-center rounded-full border border-rose-200 bg-rose-50 px-2 py-0.5 text-xs font-semibold text-rose-700">
                    {% trans 'Out' %}
                  </span>
                {% else %}
                  <span class="shrink-0 inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-xs font-semibold text-slate-700">
                    {% trans 'In Stock' %}
                  </span>
                {% endif %}
              </div>
            </td>

            <!-- Quantity -->
            <td class="px-3 py-2.5">
              <select
                name="quantity"
                {% if item.num_of_packages <= 0 %}disabled{% endif %}
                class="item-quantity w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700
                       focus:border-teal-600 focus:ring-2 focus:ring-teal-200 disabled:cursor-not-allowed disabled:bg-slate-100"
              >
                <option value="" selected>{% trans '--select--' %}</option>
                {% for i in item.package_contain|range_filter %}
                  <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>
              <p class="mt-1 text-[11px] text-slate-500">
                {% trans 'Max' %}: {{ item.package_contain }}
              </p>
            </td>

            <!-- Package -->
            <td class="px-3 py-2.5">
              <select
                name="package"
                {% if item.num_of_packages <= 0 %}disabled{% endif %}
                class="package-quantity w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700
                       focus:border-teal-600 focus:ring-2 focus:ring-teal-200 disabled:cursor-not-allowed disabled:bg-slate-100"
              >
                <option value="" selected>{% trans '--select--' %}</option>
                {% for i in item.num_of_packages|range_filter %}
                  <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>
              <p class="mt-1 text-[11px] text-slate-500">
                {% trans 'Available' %}: {{ item.num_of_packages }}
              </p>
            </td>

            <!-- Prices -->
            <td class="px-3 py-2.5 text-right">
              <input
                type="number"
                class="item-price w-32 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700 text-right tabular-nums
                       focus:border-teal-600 focus:ring-2 focus:ring-teal-200"
                value="{{ item.item_sale_price|default:'' }}"
              >
            </td>

            <td class="px-3 py-2.5 text-right">
              <input
                type="number"
                class="package-price w-32 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700 text-right tabular-nums
                       focus:border-teal-600 focus:ring-2 focus:ring-teal-200"
                value="{{ item.package_sale_price|default:'' }}"
              >
            </td>

            <!-- Action -->
            <td class="px-3 py-2.5 text-center">
              <button
                {% if item.num_of_packages <= 0 %}disabled{% endif %}
                class="add-btn inline-flex items-center justify-center rounded-lg bg-teal-700 px-3 py-2 text-xs font-semibold text-white
                       hover:bg-teal-800 disabled:cursor-not-allowed disabled:bg-slate-200 disabled:text-slate-500"
              >
                {% trans 'Add' %}
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{% if customer|length < 1 %}
  {% include 'partials/_customer_modal.html' %}
{% endif %}

<!-- Sticky notification -->
<div
  class="sticky-notification hidden fixed bottom-6 right-6 z-30 items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold text-white shadow-lg"
  id="sticky-notification"
>
  <strong id="notification">{{ cart_length }}</strong>
  <span>{% trans 'Items added to Customer Cart' %}</span>
</div>

<script src="{% static 'js/cart.js' %}"></script>
<script>
  (function () {
    const input = document.getElementById("product-search");
    const clearBtn = document.getElementById("clear-search");

    function toggleClear() {
      if (!input || !clearBtn) return;
      const hasValue = input.value && input.value.trim().length > 0;
      clearBtn.classList.toggle("hidden", !hasValue);
      clearBtn.classList.toggle("inline-flex", hasValue);
    }

    clearBtn?.addEventListener("click", () => {
      input.value = "";
      input.focus();
      toggleClear();

      // Ensure HTMX trigger fires reliably
      input.dispatchEvent(new Event("input", { bubbles: true }));
      input.dispatchEvent(new Event("keyup", { bubbles: true }));
    });

    window.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const combo =
        (isMac && e.metaKey && e.key.toLowerCase() === "k") ||
        (!isMac && e.ctrlKey && e.key.toLowerCase() === "k");

      if (combo) {
        e.preventDefault();
        input?.focus();
        input?.select();
      }
    });

    input?.addEventListener("input", toggleClear);
    toggleClear();
  })();
</script>
{% endblock content %}
