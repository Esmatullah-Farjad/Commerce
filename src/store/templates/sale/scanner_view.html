{% extends '_base.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{% trans 'Scanner' %}{% endblock title %}

{% block content %}
<div class="space-y-4">

  <!-- Header -->
  <div class="rounded-2xl border border-slate-200 bg-white px-6 py-5 shadow-sm">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-start gap-3">
        <div class="mt-0.5 flex h-10 w-10 items-center justify-center rounded-xl bg-teal-50 ring-1 ring-inset ring-teal-600/15">
          <svg class="h-5 w-5 text-teal-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
              d="M3 7h18M3 12h18M3 17h18" />
          </svg>
        </div>

        <div>
          <h1 class="text-xl font-semibold text-slate-900 leading-tight">
            {% trans 'Scan or Enter Barcode' %}
          </h1>
          <p class="mt-1 text-sm text-slate-600 max-w-2xl">
            {% trans 'Scan a barcode or type it and press Enter to add the product to the cart.' %}
          </p>

          <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-500">
            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 font-semibold text-slate-700">
              {% trans 'Tip' %}: {% trans 'Keep cursor in input for faster scanning' %}
            </span>
            <span class="hidden sm:inline rounded-md border border-slate-200 bg-slate-50 px-2 py-1 font-semibold text-slate-600">
              Enter
            </span>
          </div>
        </div>
      </div>

      <a
        href="{% url 'products-view' %}"
        class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700
               hover:bg-slate-50 hover:text-slate-900"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        </svg>
        {% trans 'Use Product Search' %}
      </a>
    </div>
  </div>

  <!-- Scanner Input -->
  <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-end lg:justify-between">
      <div class="w-full">
        <label for="barcodeInput" class="text-sm font-semibold text-slate-900">
          {% trans 'Barcode' %}
        </label>
        <p class="mt-1 text-xs text-slate-500">
          {% trans 'Scan with your device or enter the code manually.' %}
        </p>

        <div class="mt-2 relative">
          <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center">
            <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 7h16M4 12h16M4 17h16" />
            </svg>
          </span>

          <input
            type="text"
            id="barcodeInput"
            placeholder="{% trans 'Scan or type barcode and press Enter…' %}"
            class="w-full rounded-xl border border-slate-200 bg-slate-50 pl-10 pr-24 py-3 text-sm text-slate-800 shadow-sm
                   placeholder:text-slate-400
                   focus:bg-white focus:border-teal-600 focus:ring-2 focus:ring-teal-200"
            autofocus
          />

          <!-- Clear -->
          <button
            type="button"
            id="clearBarcode"
            class="absolute inset-y-0 right-2 my-1 hidden items-center rounded-lg px-3 text-xs font-semibold
                   text-slate-600 hover:bg-slate-100 hover:text-slate-900"
          >
            {% trans 'Clear' %}
          </button>
        </div>
      </div>

      <!-- Status -->
      <div class="w-full lg:w-auto">
        <div
          id="statusWrap"
          class="hidden rounded-xl border px-4 py-3 text-sm font-semibold"
          role="status"
          aria-live="polite"
        >
          <span id="status"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart -->
  <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
    <div class="flex items-center justify-between">
      <h2 class="text-sm font-semibold text-slate-900">{% trans 'Current Cart' %}</h2>
      <span class="text-xs text-slate-500">{% trans 'Updates automatically after each scan' %}</span>
    </div>
    <div class="mt-3" id="cartContainer"></div>
  </div>

  {% if customer|length < 1 %}
    {% include 'partials/_customer_modal.html' %}
  {% endif %}

<script>
  const input = document.getElementById('barcodeInput');
  const clearBtn = document.getElementById('clearBarcode');
  const statusWrap = document.getElementById('statusWrap');
  const statusEl = document.getElementById('status');

  function showStatus(type, message) {
    // type: success | error | info
    statusWrap.classList.remove('hidden');

    // reset classes
    statusWrap.className = "rounded-xl border px-4 py-3 text-sm font-semibold";

    if (type === "success") {
      statusWrap.classList.add("border-teal-200", "bg-teal-50", "text-teal-800");
    } else if (type === "error") {
      statusWrap.classList.add("border-rose-200", "bg-rose-50", "text-rose-800");
    } else {
      statusWrap.classList.add("border-slate-200", "bg-slate-50", "text-slate-700");
    }

    statusEl.textContent = message;
  }

  function toggleClear() {
    const hasValue = input.value && input.value.trim().length > 0;
    clearBtn.classList.toggle("hidden", !hasValue);
    clearBtn.classList.toggle("inline-flex", hasValue);
  }

  clearBtn.addEventListener("click", () => {
    input.value = "";
    toggleClear();
    input.focus();
    showStatus("info", "{% trans 'Ready to scan.' %}");
  });

  async function updateCartDisplay() {
    const cartHTML = await fetch("{% url 'cart-fragment' %}")
      .then(res => res.json())
      .then(data => data.html);
    document.getElementById('cartContainer').innerHTML = cartHTML;
  }

  async function handleBarcodeSubmit() {
    const barcode = input.value.trim();
    if (!barcode) return;

    input.value = "";
    toggleClear();
    showStatus("info", "{% trans 'Searching barcode…' %}");

    const response = await fetch('{% url "get-product-by-barcode" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: `barcode=${encodeURIComponent(barcode)}`
    });

    const result = await response.json();

    if (result.status === 'success') {
      const product = result.product;

      const cartResponse = await fetch('{% url "add-to-cart" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          product_id: product.id,
          item_quantity: 1,
          package_quantity: 0,
          item_price: product.item_price,
          package_price: product.package_price
        })
      });

      const cartResult = await cartResponse.json();

      if (cartResult.status === 200) {
        showStatus("success", `${product.name} {% trans 'added to cart.' %}`);
        document.getElementById('cart_length').innerText = cartResult.cart_length;
        await updateCartDisplay();
      } else {
        showStatus("error", "{% trans 'Failed to add to cart.' %}");
      }
    } else {
      showStatus("error", result.message || "{% trans 'Product not found.' %}");
    }

    // keep focus for continuous scanning
    input.focus();
  }

  // Use Enter (better for scanners + keyboards)
  input.addEventListener('keydown', (e) => {
    toggleClear();
    if (e.key === 'Enter') {
      e.preventDefault();
      handleBarcodeSubmit();
    }
  });

  // Fallback for scanners that trigger change
  input.addEventListener('change', handleBarcodeSubmit);

  window.addEventListener('DOMContentLoaded', async () => {
    await updateCartDisplay();
    showStatus("info", "{% trans 'Ready to scan.' %}");
    input.focus();
    toggleClear();
  });
</script>

</div>
{% endblock content %}
