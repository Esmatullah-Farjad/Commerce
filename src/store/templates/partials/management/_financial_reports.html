{% extends 'dashboard/dashboard-view.html' %}
{% load i18n %}
{% load humanize %}

{% block dashboard %}
<div class="space-y-4">
  <section class="rounded-2xl border border-slate-200 bg-gradient-to-r from-slate-950 via-sky-900 to-teal-900 px-5 py-4 text-white shadow-lg">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-end lg:justify-between">
      <div>
        <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-sky-200">{% trans "Finance Dashboard" %}</p>
        <h1 class="mt-1 text-xl font-bold">{% trans "Financial Reports" %}</h1>
        <p class="mt-1 text-xs text-slate-200">{% trans "Interactive compact financial analytics for management." %}</p>
      </div>
      <form method="get" class="grid gap-2 rounded-xl border border-white/20 bg-white/10 p-2 sm:grid-cols-2 lg:grid-cols-5 lg:w-[940px]">
        <select name="scope" class="w-full rounded-lg border border-white/20 bg-white/10 px-2 py-2 text-xs text-white">
          {% if can_tenant_scope %}<option value="tenant" {% if scope == 'tenant' %}selected{% endif %}>{% trans 'Tenant' %}</option>{% endif %}
          <option value="store" {% if scope == 'store' %}selected{% endif %}>{% trans 'Store' %}</option>
          <option value="branch" {% if scope == 'branch' %}selected{% endif %}>{% trans 'Branch' %}</option>
        </select>
        <select name="store_id" class="w-full rounded-lg border border-white/20 bg-white/10 px-2 py-2 text-xs text-white">
          <option value="">{% trans 'Store' %}</option>
          {% for store in store_options %}<option value="{{ store.id }}" {% if scope_store and scope_store.id == store.id %}selected{% endif %}>{{ store.name }}</option>{% endfor %}
        </select>
        <select name="branch_id" class="w-full rounded-lg border border-white/20 bg-white/10 px-2 py-2 text-xs text-white">
          <option value="">{% trans 'Branch' %}</option>
          {% for branch in branch_options %}<option value="{{ branch.id }}" {% if scope_branch and scope_branch.id == branch.id %}selected{% endif %}>{{ branch.store.name }} / {{ branch.name }}</option>{% endfor %}
        </select>
        <input name="from_date" value="{{ request.GET.from_date|default:'' }}" placeholder="{% trans 'From YYYY-MM-DD' %}" class="w-full rounded-lg border border-white/20 bg-white/10 px-2 py-2 text-xs text-white placeholder:text-slate-300">
        <div class="flex gap-2">
          <input name="to_date" value="{{ request.GET.to_date|default:'' }}" placeholder="{% trans 'To YYYY-MM-DD' %}" class="w-full rounded-lg border border-white/20 bg-white/10 px-2 py-2 text-xs text-white placeholder:text-slate-300">
          <button type="submit" class="rounded-lg bg-sky-300 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-sky-200">{% trans 'Apply' %}</button>
        </div>
      </form>
    </div>
  </section>

  <section class="grid gap-3 grid-cols-2 lg:grid-cols-4">
    <article class="rounded-xl border border-slate-200 bg-white p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-slate-500">{% trans 'Sales' %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ sales_total|intcomma }}</p><p class="text-[11px] text-slate-500">AFN</p></article>
    <article class="rounded-xl border border-cyan-200 bg-cyan-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-cyan-700">{% trans 'Purchases' %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ purchase_total|intcomma }}</p><p class="text-[11px] text-cyan-700">AFN</p></article>
    <article class="rounded-xl border border-emerald-200 bg-emerald-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-emerald-700">{% trans 'Gross Profit' %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ gross_profit|intcomma }}</p><p class="text-[11px] text-emerald-700">AFN</p></article>
    <article class="rounded-xl border border-rose-200 bg-rose-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-rose-700">{% trans 'Net Profit/Loss' %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ net_profit|intcomma }}</p><p class="text-[11px] text-rose-700">AFN</p></article>
  </section>

  <section class="grid gap-4 xl:grid-cols-12">
    <div class="space-y-4 xl:col-span-8">
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="mb-2 flex items-center justify-between"><h2 class="text-sm font-semibold text-slate-900">{% trans 'Finance Trend' %}</h2><span class="text-xs text-slate-500">{% trans 'Hover for values' %}</span></div>
        <div class="h-44"><canvas id="financeTrendChart"></canvas></div>
      </article>
      <div class="grid gap-4 md:grid-cols-2">
        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-sm font-semibold text-slate-900">{% trans 'Assets vs Liabilities' %}</h2>
          <div class="mt-2 h-36"><canvas id="assetLiabilityChart"></canvas></div>
          <div class="mt-2 grid grid-cols-2 gap-1 text-[11px]">
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Assets' %}: {{ assets_total|intcomma }}</div>
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Liabilities' %}: {{ liabilities_total|intcomma }}</div>
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Cash' %}: {{ cash_balance|intcomma }}</div>
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Inventory' %}: {{ inventory_balance|intcomma }}</div>
          </div>
        </article>
        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-sm font-semibold text-slate-900">{% trans 'Transaction Types' %}</h2>
          <div class="mt-2 h-36"><canvas id="transactionTypeChart"></canvas></div>
          <ul id="trxTypeData" class="mt-2 space-y-1 text-[11px] text-slate-600"></ul>
        </article>
      </div>
    </div>

    <div class="space-y-4 xl:col-span-4">
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-sm font-semibold text-slate-900">{% trans 'P&L Mix' %}</h2>
        <div class="mt-2 mx-auto h-40 w-40"><canvas id="pnlChart"></canvas></div>
        <div class="mt-2 grid gap-1 text-[11px]">
          <div class="flex items-center justify-between rounded bg-teal-50 px-2 py-1"><span class="text-teal-700">{% trans 'Sales Revenue' %}</span><span class="font-semibold">{{ sales_revenue|intcomma }}</span></div>
          <div class="flex items-center justify-between rounded bg-cyan-50 px-2 py-1"><span class="text-cyan-700">{% trans 'Other Income' %}</span><span class="font-semibold">{{ other_income_value|intcomma }}</span></div>
          <div class="flex items-center justify-between rounded bg-amber-50 px-2 py-1"><span class="text-amber-700">{% trans 'COGS' %}</span><span class="font-semibold">{{ cogs_total|intcomma }}</span></div>
          <div class="flex items-center justify-between rounded bg-rose-50 px-2 py-1"><span class="text-rose-700">{% trans 'Op. Expense' %}</span><span class="font-semibold">{{ operating_expense|intcomma }}</span></div>
        </div>
      </article>

      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-sm font-semibold text-slate-900">{% trans 'Top Ledger Balances' %}</h2>
        <div class="mt-2 h-36"><canvas id="ledgerTopChart"></canvas></div>
      </article>
    </div>
  </section>

  <section class="grid gap-4 xl:grid-cols-2">
    <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between"><h2 class="text-sm font-semibold text-slate-900">{% trans 'Journal Transactions' %}</h2><span class="text-xs text-slate-500">{{ transactions|length }}</span></div>
      <div class="max-h-56 overflow-y-auto rounded-lg border border-slate-100">
        <table class="min-w-full text-left text-xs">
          <thead class="sticky top-0 bg-slate-50 text-[10px] font-semibold uppercase tracking-wide text-slate-600">
            <tr><th class="px-2 py-2">{% trans 'Date' %}</th><th class="px-2 py-2">{% trans 'Type' %}</th><th class="px-2 py-2">{% trans 'Ref' %}</th><th class="px-2 py-2 text-right">{% trans 'Amount' %}</th></tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for trx in transactions %}
            <tr><td class="px-2 py-2 text-slate-700">{{ trx.entry.entry_date }}</td><td class="px-2 py-2 text-slate-700">{{ trx.entry.get_reference_type_display }}</td><td class="px-2 py-2 text-slate-600">{{ trx.entry.reference_id|default:'-' }}</td><td class="px-2 py-2 text-right font-semibold text-slate-900">{{ trx.total|intcomma }}</td></tr>
            {% empty %}<tr><td colspan="4" class="px-2 py-6 text-center text-slate-500">{% trans 'No data' %}</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </article>

    <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between"><h2 class="text-sm font-semibold text-slate-900">{% trans 'General Ledger' %}</h2><span class="text-xs text-slate-500">{{ ledger_rows|length }}</span></div>
      <div class="max-h-56 overflow-y-auto rounded-lg border border-slate-100">
        <table class="min-w-full text-left text-xs">
          <thead class="sticky top-0 bg-slate-50 text-[10px] font-semibold uppercase tracking-wide text-slate-600">
            <tr><th class="px-2 py-2">{% trans 'Code' %}</th><th class="px-2 py-2">{% trans 'Account' %}</th><th class="px-2 py-2 text-right">{% trans 'Balance' %}</th></tr>
          </thead>
          <tbody class="divide-y divide-slate-100">
            {% for row in ledger_rows %}
            <tr><td class="px-2 py-2 text-slate-700">{{ row.code }}</td><td class="px-2 py-2 text-slate-700">{{ row.name }}</td><td class="px-2 py-2 text-right font-semibold text-slate-900">{{ row.balance|intcomma }}</td></tr>
            {% empty %}<tr><td colspan="3" class="px-2 py-6 text-center text-slate-500">{% trans 'No data' %}</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </article>
  </section>
</div>

{{ trend_labels|json_script:"fin-trend-labels" }}
{{ trend_sales|json_script:"fin-trend-sales" }}
{{ trend_purchase|json_script:"fin-trend-purchase" }}
{{ trend_expense|json_script:"fin-trend-expense" }}
{{ trend_net|json_script:"fin-trend-net" }}
{{ pnl_labels|json_script:"fin-pnl-labels" }}
{{ pnl_values|json_script:"fin-pnl-values" }}
{{ asset_liability_labels|json_script:"fin-asset-liability-labels" }}
{{ asset_liability_values|json_script:"fin-asset-liability-values" }}
{{ trx_type_labels|json_script:"fin-trx-type-labels" }}
{{ trx_type_values|json_script:"fin-trx-type-values" }}
{{ ledger_top_labels|json_script:"fin-ledger-top-labels" }}
{{ ledger_top_values|json_script:"fin-ledger-top-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
(function () {
  function readJson(id, fallback) {
    const node = document.getElementById(id);
    if (!node) return fallback;
    try { return JSON.parse(node.textContent); } catch (e) { return fallback; }
  }
  if (!window.Chart) return;

  new Chart(document.getElementById('financeTrendChart'), {
    type: 'line',
    data: {
      labels: readJson('fin-trend-labels', []),
      datasets: [
        { label: '{% trans "Sales" %}', data: readJson('fin-trend-sales', []), borderColor: '#0f766e', tension: 0.35, pointRadius: 2 },
        { label: '{% trans "Purchases" %}', data: readJson('fin-trend-purchase', []), borderColor: '#0284c7', tension: 0.35, pointRadius: 2 },
        { label: '{% trans "Expense" %}', data: readJson('fin-trend-expense', []), borderColor: '#e11d48', tension: 0.35, pointRadius: 2 },
        { label: '{% trans "Net" %}', data: readJson('fin-trend-net', []), borderColor: '#16a34a', tension: 0.35, pointRadius: 2 },
      ]
    },
    options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }, scales: { x: { ticks: { maxTicksLimit: 6 } }, y: { beginAtZero: true } } }
  });

  new Chart(document.getElementById('assetLiabilityChart'), {
    type: 'doughnut',
    data: { labels: readJson('fin-asset-liability-labels', []), datasets: [{ data: readJson('fin-asset-liability-values', []), backgroundColor: ['#2563eb', '#7c3aed'] }] },
    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }, cutout: '60%' }
  });

  const trxLabels = readJson('fin-trx-type-labels', []);
  const trxValues = readJson('fin-trx-type-values', []);
  new Chart(document.getElementById('transactionTypeChart'), {
    type: 'bar',
    data: { labels: trxLabels, datasets: [{ data: trxValues, backgroundColor: '#334155', borderRadius: 6 }] },
    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
  });

  const trxList = document.getElementById('trxTypeData');
  if (trxList) {
    trxList.innerHTML = trxLabels.map((label, idx) => '<li class="flex items-center justify-between rounded bg-slate-50 px-2 py-1"><span>' + label + '</span><span class="font-semibold">' + (trxValues[idx] || 0) + '</span></li>').join('');
  }

  new Chart(document.getElementById('pnlChart'), {
    type: 'doughnut',
    data: { labels: readJson('fin-pnl-labels', []), datasets: [{ data: readJson('fin-pnl-values', []), backgroundColor: ['#0f766e', '#0891b2', '#f59e0b', '#e11d48'] }] },
    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }, cutout: '62%' }
  });

  new Chart(document.getElementById('ledgerTopChart'), {
    type: 'bar',
    data: { labels: readJson('fin-ledger-top-labels', []), datasets: [{ data: readJson('fin-ledger-top-values', []), backgroundColor: '#0ea5e9', borderRadius: 6 }] },
    options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
  });
})();
</script>
{% endblock dashboard %}
