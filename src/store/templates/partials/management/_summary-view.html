{% extends 'dashboard/dashboard-view.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}

{% block dashboard %}
<div class="space-y-4">
  <section class="rounded-2xl border border-slate-200 bg-gradient-to-r from-slate-950 via-slate-900 to-teal-900 px-5 py-4 text-white shadow-lg">
    <div class="flex flex-col gap-3 lg:flex-row lg:items-end lg:justify-between">
      <div>
        <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-teal-200">{% trans "Admin Dashboard" %}</p>
        <h1 class="mt-1 text-xl font-bold">{% trans "Sales Intelligence" %}</h1>
        <p class="mt-1 text-xs text-slate-200">{% trans "Interactive and compact sales analytics." %}</p>
      </div>
      <form method="get" class="grid gap-2 rounded-xl border border-white/20 bg-white/10 p-2 sm:grid-cols-3 lg:w-[520px]">
        <input type="text" name="from_date" value="{{ request.GET.from_date|default_if_none:'' }}" placeholder="{% trans 'From YYYY-MM-DD' %}" class="datepicker-jalali w-full rounded-lg border border-white/20 bg-white/10 px-3 py-2 text-xs text-white placeholder:text-slate-300">
        <input type="text" name="to_date" value="{{ request.GET.to_date|default_if_none:'' }}" placeholder="{% trans 'To YYYY-MM-DD' %}" class="datepicker-jalali w-full rounded-lg border border-white/20 bg-white/10 px-3 py-2 text-xs text-white placeholder:text-slate-300">
        <button type="submit" class="rounded-lg bg-teal-300 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-teal-200">{% trans "Apply" %}</button>
      </form>
    </div>
  </section>

  <section class="grid gap-3 grid-cols-2 lg:grid-cols-3 xl:grid-cols-6">
    <article class="rounded-xl border border-slate-200 bg-white p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-slate-500">{% trans "Sales" %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ total_value|intcomma }}</p><p class="text-[11px] text-slate-500">AFN</p></article>
    <article class="rounded-xl border border-emerald-200 bg-emerald-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-emerald-700">{% trans "Paid" %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ total_paid|intcomma }}</p><p class="text-[11px] text-emerald-700">AFN</p></article>
    <article class="rounded-xl border border-amber-200 bg-amber-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-amber-700">{% trans "Unpaid" %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ total_unpaid|intcomma }}</p><p class="text-[11px] text-amber-700">AFN</p></article>
    <article class="rounded-xl border border-slate-200 bg-white p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-slate-500">{% trans "Customers" %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ total_customer }}</p><p class="text-[11px] text-slate-500">{% trans "distinct" %}</p></article>
    <article class="rounded-xl border border-cyan-200 bg-cyan-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-cyan-700">{% trans "Income" %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ total_income|intcomma }}</p><p class="text-[11px] text-cyan-700">AFN</p></article>
    <article class="rounded-xl border border-rose-200 bg-rose-50 p-3 shadow-sm"><p class="text-[11px] font-semibold uppercase tracking-[0.14em] text-rose-700">{% trans "Net" %}</p><p class="mt-1 text-lg font-bold text-slate-900">{{ net_balance|intcomma }}</p><p class="text-[11px] text-rose-700">AFN</p></article>
  </section>

  <section class="grid gap-4 xl:grid-cols-12">
    <div class="space-y-4 xl:col-span-8">
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="mb-2 flex items-center justify-between"><h2 class="text-sm font-semibold text-slate-900">{% trans "Sales Trend" %}</h2><span class="text-xs text-slate-500">{% trans "Hover for details" %}</span></div>
        <div class="h-44"><canvas id="summaryTrendChart"></canvas></div>
      </article>
      <div class="grid gap-4 md:grid-cols-2">
        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-sm font-semibold text-slate-900">{% trans "Revenue vs Cost" %}</h2>
          <div class="mt-2 h-36"><canvas id="revCostChart"></canvas></div>
          <div class="mt-2 grid grid-cols-2 gap-1 text-[11px]">
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Sales' %}: {{ total_value|intcomma }}</div>
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Income' %}: {{ total_income|intcomma }}</div>
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Expense' %}: {{ total_expense|intcomma }}</div>
            <div class="rounded bg-slate-50 px-2 py-1">{% trans 'Net' %}: {{ net_balance|intcomma }}</div>
          </div>
        </article>
        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-sm font-semibold text-slate-900">{% trans "Top Products" %}</h2>
          <div class="mt-2 h-36"><canvas id="topProductsChart"></canvas></div>
          <ul id="topProductsData" class="mt-2 space-y-1 text-[11px] text-slate-600"></ul>
        </article>
      </div>
    </div>

    <div class="space-y-4 xl:col-span-4">
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-sm font-semibold text-slate-900">{% trans "Payment Mix" %}</h2>
        <div class="mt-2 mx-auto h-40 w-40"><canvas id="paymentMixChart"></canvas></div>
        <div class="mt-2 grid gap-1 text-[11px]">
          <div class="flex items-center justify-between rounded bg-emerald-50 px-2 py-1"><span class="text-emerald-700">{% trans 'Paid' %}</span><span class="font-semibold">{{ total_paid|intcomma }}</span></div>
          <div class="flex items-center justify-between rounded bg-amber-50 px-2 py-1"><span class="text-amber-700">{% trans 'Unpaid' %}</span><span class="font-semibold">{{ total_unpaid|intcomma }}</span></div>
        </div>
      </article>

      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <div class="mb-2 flex items-center justify-between"><h2 class="text-sm font-semibold text-slate-900">{% trans "Recent Sales" %}</h2><span class="text-xs text-slate-500">{{ sales|length }}</span></div>
        <div class="max-h-56 overflow-y-auto rounded-lg border border-slate-100">
          <table class="min-w-full text-left text-xs">
            <thead class="sticky top-0 bg-slate-50 text-[10px] font-semibold uppercase tracking-wide text-slate-600">
              <tr><th class="px-2 py-2">{% trans "Bill" %}</th><th class="px-2 py-2">{% trans "Customer" %}</th><th class="px-2 py-2 text-right">{% trans "Total" %}</th></tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              {% for sale in sales|slice:":10" %}
              <tr><td class="px-2 py-2 font-semibold text-slate-800">{{ sale.bill_number }}</td><td class="px-2 py-2 text-slate-600">{{ sale.customer.name }}</td><td class="px-2 py-2 text-right font-medium text-slate-900">{{ sale.total_amount|intcomma }}</td></tr>
              {% empty %}
              <tr><td colspan="3" class="px-2 py-6 text-center text-slate-500">{% trans "No sales" %}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
    </div>
  </section>
</div>

{{ trend_labels|json_script:"summary-trend-labels" }}
{{ trend_sales|json_script:"summary-trend-sales" }}
{{ trend_paid|json_script:"summary-trend-paid" }}
{{ trend_unpaid|json_script:"summary-trend-unpaid" }}
{{ payment_mix|json_script:"summary-payment-mix" }}
{{ revenue_cost_labels|json_script:"summary-revcost-labels" }}
{{ revenue_cost_values|json_script:"summary-revcost-values" }}
{{ top_product_labels|json_script:"summary-top-products-labels" }}
{{ top_product_values|json_script:"summary-top-products-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
(function () {
  function readJson(id, fallback) {
    const node = document.getElementById(id);
    if (!node) return fallback;
    try { return JSON.parse(node.textContent); } catch (e) { return fallback; }
  }
  if (!window.Chart) return;

  const labels = readJson('summary-trend-labels', []);
  const sales = readJson('summary-trend-sales', []);
  const paid = readJson('summary-trend-paid', []);
  const unpaid = readJson('summary-trend-unpaid', []);

  new Chart(document.getElementById('summaryTrendChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: '{% trans "Sales" %}', data: sales, borderColor: '#0f766e', backgroundColor: 'rgba(15,118,110,0.15)', tension: 0.35, fill: true, pointRadius: 2 },
        { label: '{% trans "Paid" %}', data: paid, borderColor: '#16a34a', tension: 0.35, pointRadius: 2 },
        { label: '{% trans "Unpaid" %}', data: unpaid, borderColor: '#f59e0b', tension: 0.35, pointRadius: 2 },
      ]
    },
    options: { maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } } }, scales: { x: { ticks: { maxTicksLimit: 6 } }, y: { beginAtZero: true } } }
  });

  new Chart(document.getElementById('paymentMixChart'), {
    type: 'doughnut',
    data: { labels: ['{% trans "Paid" %}', '{% trans "Unpaid" %}'], datasets: [{ data: readJson('summary-payment-mix', [0, 0]), backgroundColor: ['#16a34a', '#f59e0b'], borderWidth: 1 }] },
    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } }, cutout: '62%' }
  });

  new Chart(document.getElementById('revCostChart'), {
    type: 'bar',
    data: { labels: readJson('summary-revcost-labels', []), datasets: [{ data: readJson('summary-revcost-values', []), backgroundColor: ['#0f766e', '#0891b2', '#e11d48', '#7c3aed'], borderRadius: 6 }] },
    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  const topLabels = readJson('summary-top-products-labels', []);
  const topValues = readJson('summary-top-products-values', []);
  new Chart(document.getElementById('topProductsChart'), {
    type: 'bar',
    data: { labels: topLabels, datasets: [{ data: topValues, backgroundColor: '#2563eb', borderRadius: 6 }] },
    options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
  });

  const list = document.getElementById('topProductsData');
  if (list) {
    list.innerHTML = topLabels.map((label, idx) => '<li class="flex items-center justify-between rounded bg-slate-50 px-2 py-1"><span>' + label + '</span><span class="font-semibold">' + (topValues[idx] || 0).toLocaleString() + '</span></li>').join('');
  }

  if (window.jQuery && jQuery.fn.pDatepicker) {
    jQuery('.datepicker-jalali').pDatepicker({ format: 'YYYY-MM-DD', calendar: { persian: { locale: 'fa' } }, autoClose: true, initialValue: false });
  }
})();
</script>
{% endblock dashboard %}
